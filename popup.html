<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Web Carbon Calculator</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css">

    </head>
<!--prototype eco friendly-->
<script type="module">

    import tgwf from "https://esm.sh/@tgwf/co2";

    // using the Sustainable Web Design Model for calculations
    const emissions = new tgwf.co2({ model: "swd"});

    const localStorageKey = 'ecoDismissedData';
    // todo: 10 minute for testing, to change this
    const MAX_AGE_MS = 10 * 60 * 1000; // 10 minutes

    function calculatePageEmissions() {

        if (!window.performance || !performance.getEntriesByType) {
// todo: handle error properly
            console.log("‚ö†Ô∏è Your browser does not support the CO‚ÇÇ calculator.");
            return;
        }

        if (!emissions) {
// todo: handle error properly
            console.log("‚ö†Ô∏è Oops! Something went wrong with the CO‚ÇÇ calculator.");
            return;
        }

// get resources loaded
        const resources = performance.getEntriesByType("resource");
        let totalBytes = 0;

// get transfer size
        const navigationEntries = performance.getEntriesByType("navigation");
        if (navigationEntries.length > 0) {
            totalBytes += navigationEntries[0].transferSize;
        }

        resources.forEach(resource => {
            if (resource.transferSize) {
                totalBytes += resource.transferSize;
            }
        });

        const totalKB = (totalBytes / 1024).toFixed(2);
        const greenHost = false;
        const estimatedCO2 = emissions.perByte(totalBytes, greenHost).toFixed(3);
        const drivingDistance = (estimatedCO2 / 0.12).toFixed(2);

        console.log(`This page downloaded ${totalKB} KB (${totalBytes} bytes)`);
        console.log(`Estimated emissions: ${estimatedCO2} grams of CO2`);

        const message = `
<div class="toast-body-response">
<!--<p>This page downloaded <strong>${totalKB} KB</strong></p>-->
<p>Estimated emissions for this page: <strong>${estimatedCO2} g CO‚ÇÇ</strong>.</p>
<p>That's like driving a petrol car for <strong>${drivingDistance} meters</strong> just to load this page. üöó</p>
<p><strong>Switching to Eco-Friendly Mode</strong> could reduce CO‚ÇÇ emissions by up to <strong>70%</strong>!üåø</p>
</div>
`;
        updateToast(message);
    }

    function updateToast(html) {

        const toastBody = document.querySelector(".toast-body");
        if (toastBody) {
            toastBody.innerHTML = html;
        }
    }

    // Run after page load (and a delay for complete resource capture)
    window.addEventListener("load", () => {

        const closeBtn = document.getElementById("co2ToastClose");
        if (closeBtn) {
            closeBtn.addEventListener("click", () => {
                const data = {
                    timestamp: Date.now()
                };
                localStorage.setItem(localStorageKey, JSON.stringify(data));
            });
        }

// below to remove to run and uncomment code after
        localStorage.removeItem(localStorageKey);



        if (shouldRunEmissionsScript()) {
// display toast
            const toast = document.querySelector(".co2-toast");
            toast.classList.add("show");
            setTimeout(calculatePageEmissions, 8000);
        }
    });

    function shouldRunEmissionsScript() {
        const saved = localStorage.getItem(localStorageKey);
        if (!saved) return true; // No record ‚Üí go ahead and run

        try {
            const parsed = JSON.parse(saved);
            const lastClosedTime = parsed.timestamp;

// If less than MAX_AGE_MS has passed, don't run
            if (Date.now() - lastClosedTime < MAX_AGE_MS) {
                return false;
            }

// Otherwise, clear and allow running again
            localStorage.removeItem(localStorageKey);
            return true;

        } catch (e) {
// In case of corrupted data, reset and run
            localStorage.removeItem(localStorageKey);
            return true;
        }
    }

</script>
<!--temporary set to display none-->
<div id="co2Toast" class="toast co2-toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
        <strong class="me-auto">üåç CO‚ÇÇ Tracker</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" id="co2ToastClose" aria-label="Close"></button>
    </div>
    <div class="toast-body d-flex align-items-center">
        <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>
        <span id="co2Message" class="dots-loading">Calculating CO‚ÇÇ emissions</span>
    </div>
</div>
<style>
    .show-toast-btn{
        position: fixed;
        top: 11rem;
        right: -70px;
        transform: rotate(-90deg);
        background-color: green;
        color: white;
        z-index: 9999;
    }
    .co2-toast{
        background-color: rgba(255, 255, 255, 1);
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 9999;
    }
    .co2-toast .toast-body .toast-body-response p{
        margin-bottom: 0;
        padding-bottom: 0;
    }
    .dots-loading::after {
        content: '';
        display: inline-block;
        animation: dots 1.4s steps(4, end) infinite;
        overflow: hidden;
        vertical-align: bottom;
        width: 0ch;
    }
    @keyframes dots {
        0% { content: ''; width: 0ch; }
        25% { content: '.'; width: 1ch; }
        50% { content: '..'; width: 2ch; }
        75% { content: '...'; width: 3ch; }
        100% { content: ''; width: 0ch; }
    }
</style>
</html>